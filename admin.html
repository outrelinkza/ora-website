<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORA Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0A0B14;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        /* Background Grid */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            opacity: 0.2;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 24px 24px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Auth Section */
        .auth-section {
            max-width: 420px;
            margin: 120px auto;
            padding: 48px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            text-align: center;
        }

        .auth-section h2 {
            font-family: 'Manrope', sans-serif;
            font-size: 28px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .auth-section p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 32px;
        }

        .auth-section input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .auth-section input:focus {
            outline: none;
            border-color: rgba(249, 115, 22, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .auth-section input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .auth-section button {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            background: rgba(249, 115, 22, 0.15);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 12px;
            color: #ffffff;
            font-weight: 600;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-section button:hover {
            background: rgba(249, 115, 22, 0.25);
            border-color: rgba(249, 115, 22, 0.5);
        }

        .auth-error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 24px 32px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }

        .header h1 {
            font-family: 'Manrope', sans-serif;
            font-size: 32px;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .header .logout-btn {
            padding: 10px 20px;
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
            border-radius: 10px;
            color: #ff3b30;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .header .logout-btn:hover {
            background: rgba(255, 59, 48, 0.2);
            border-color: rgba(255, 59, 48, 0.3);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .tab.active {
            background: rgba(249, 115, 22, 0.15);
            border-color: rgba(249, 115, 22, 0.3);
            color: #ffffff;
        }

        /* Content */
        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            padding: 28px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }

        .stat-card h3 {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
        }

        .stat-card .value {
            font-family: 'Manrope', sans-serif;
            font-size: 36px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .stat-card .label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Inter', sans-serif;
        }

        /* Table Container */
        .table-container {
            padding: 32px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            overflow-x: auto;
        }

        .table-container h3 {
            font-family: 'Manrope', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
        }

        td {
            color: #ffffff;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .filter-btn.active {
            background: rgba(249, 115, 22, 0.15);
            border-color: rgba(249, 115, 22, 0.3);
            color: #ffffff;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .badge.rate {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge.bug {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        /* Loading & Error States */
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Inter', sans-serif;
        }

        .error {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            margin-bottom: 20px;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Section (shown when not authenticated) -->
        <div id="authSection" class="auth-section">
            <h2>Admin Login</h2>
            <p>Enter your password to access the dashboard</p>
            <input type="password" id="adminPassword" placeholder="Enter admin password" />
            <button onclick="authenticate()">Login</button>
            <p id="authError" class="auth-error"></p>
        </div>

        <!-- Main Dashboard (shown when authenticated) -->
        <div id="dashboard" style="display: none;">
            <div class="header">
                <h1>ORA Admin Dashboard</h1>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">Overview</div>
                <div class="tab" onclick="switchTab('submissions')">Submissions</div>
                <div class="tab" onclick="switchTab('analytics')">Analytics</div>
                <div class="tab" onclick="switchTab('errors')">Errors</div>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Rate Submissions</h3>
                        <div class="value" id="rateSubmissionsCount">-</div>
                        <div class="label">Total submissions</div>
                    </div>
                    <div class="stat-card">
                        <h3>Bug Reports</h3>
                        <div class="value" id="bugReportsCount">-</div>
                        <div class="label">Total reports</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="value" id="activeUsersCount">-</div>
                        <div class="label">Unique users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Submissions</h3>
                        <div class="value" id="totalSubmissionsCount">-</div>
                        <div class="label">All submissions</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Submissions Tab -->
            <div id="submissions" class="content">
                <div class="filter-bar">
                    <div class="filter-btn active" onclick="filterSubmissions('all')">All</div>
                    <div class="filter-btn" onclick="filterSubmissions('rates')">Rate Submissions</div>
                    <div class="filter-btn" onclick="filterSubmissions('bugs')">Bug Reports</div>
                </div>
                <div class="table-container">
                    <h3>Submissions</h3>
                    <div id="submissionsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="totalUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Paid Users</h3>
                        <div class="value" id="paidUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Subscription Revenue</h3>
                        <div class="value" id="subscriptionRevenue">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Conversion Rate</h3>
                        <div class="value" id="conversionRate">-</div>
                    </div>
                </div>
                <div class="table-container">
                    <h3>Platform Distribution</h3>
                    <div id="platformDistribution">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Errors Tab -->
            <div id="errors" class="content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Errors</h3>
                        <div class="value" id="totalErrors">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Critical Errors</h3>
                        <div class="value" id="criticalErrors" style="color: #ff3b30;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Resolved</h3>
                        <div class="value" id="resolvedErrors" style="color: #10b981;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Unresolved</h3>
                        <div class="value" id="unresolvedErrors" style="color: #f59e0b;">-</div>
                    </div>
                </div>
                <div class="table-container">
                    <h3>Recent Errors</h3>
                    <div id="errorsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Admin password (in production, use environment variable)
        const ADMIN_PASSWORD = 'ora_admin_2025';
        let currentFilter = 'all';

        // Check if already authenticated
        if (localStorage.getItem('admin_authenticated') === 'true' && localStorage.getItem('admin_token')) {
            showDashboard();
        }

        async function authenticate() {
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('authError');
            
            if (password === ADMIN_PASSWORD) {
                // Get admin token from backend
                try {
                    const response = await fetch('/api/admin/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        localStorage.setItem('admin_authenticated', 'true');
                        localStorage.setItem('admin_token', data.token || ADMIN_PASSWORD);
                        showDashboard();
                        errorEl.style.display = 'none';
                    } else {
                        throw new Error('Authentication failed');
                    }
                } catch (error) {
                    // Fallback: use password as token for local testing
                    localStorage.setItem('admin_authenticated', 'true');
                    localStorage.setItem('admin_token', ADMIN_PASSWORD);
                    showDashboard();
                    errorEl.style.display = 'none';
                }
            } else {
                errorEl.textContent = 'Invalid password';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('admin_authenticated');
            localStorage.removeItem('admin_token');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadAllData();
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for the tab
            if (tabName === 'submissions') {
                loadSubmissions();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'errors') {
                loadErrors();
            }
        }

        function filterSubmissions(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadSubmissions();
        }

        async function loadAllData() {
            await Promise.all([
                loadOverview(),
                loadSubmissions(),
                loadAnalytics(),
                loadErrors()
            ]);
        }

        async function loadOverview() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin/overview?token=${adminToken}`);
                const data = await response.json();

                document.getElementById('rateSubmissionsCount').textContent = data.rateSubmissions || 0;
                document.getElementById('bugReportsCount').textContent = data.bugReports || 0;
                document.getElementById('activeUsersCount').textContent = data.activeUsers || 0;
                document.getElementById('totalSubmissionsCount').textContent = data.totalSubmissions || 0;

                // Render recent activity
                const activityEl = document.getElementById('recentActivity');
                if (data.recentActivity && data.recentActivity.length > 0) {
                    activityEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Details</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recentActivity.map(item => `
                                    <tr>
                                        <td><span class="badge ${item.type === 'rate_submission' ? 'rate' : 'bug'}">${item.type === 'rate_submission' ? 'Rate' : 'Bug'}</span></td>
                                        <td>${item.details || 'N/A'}</td>
                                        <td>${new Date(item.date).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    activityEl.innerHTML = '<div class="empty-state">No recent activity</div>';
                }
            } catch (error) {
                console.error('Error loading overview:', error);
                document.getElementById('recentActivity').innerHTML = '<div class="error">Failed to load overview data</div>';
            }
        }

        async function loadSubmissions() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin/submissions?filter=${currentFilter}&token=${adminToken}`);
                const data = await response.json();

                const submissionsEl = document.getElementById('submissionsList');
                if (data.submissions && data.submissions.length > 0) {
                    submissionsEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Details</th>
                                    <th>User Email</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.submissions.map(sub => `
                                    <tr>
                                        <td><span class="badge ${sub.type === 'rate_submission' ? 'rate' : 'bug'}">${sub.type === 'rate_submission' ? 'Rate' : 'Bug'}</span></td>
                                        <td>${sub.details || 'N/A'}</td>
                                        <td>${sub.userEmail || 'N/A'}</td>
                                        <td>${new Date(sub.submittedAt).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    submissionsEl.innerHTML = '<div class="empty-state">No submissions found</div>';
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissionsList').innerHTML = '<div class="error">Failed to load submissions</div>';
            }
        }

        async function loadAnalytics() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin/analytics?token=${adminToken}`);
                const data = await response.json();

                document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                document.getElementById('paidUsers').textContent = data.paidUsers || 0;
                document.getElementById('subscriptionRevenue').textContent = `$${data.subscriptionRevenue?.toFixed(0) || 0}`;
                document.getElementById('conversionRate').textContent = `${data.conversionRate?.toFixed(1) || 0}%`;

                // Platform distribution
                const platformEl = document.getElementById('platformDistribution');
                if (data.platformDistribution && Object.keys(data.platformDistribution).length > 0) {
                    platformEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Platform</th>
                                    <th>Submissions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(data.platformDistribution).map(([platform, count]) => `
                                    <tr>
                                        <td>${platform}</td>
                                        <td>${count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    platformEl.innerHTML = '<div class="empty-state">No platform data available</div>';
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadErrors() {
            try {
                const adminToken = localStorage.getItem('admin_token') || '';
                const response = await fetch(`/api/admin/errors?token=${adminToken}`);
                const data = await response.json();

                document.getElementById('totalErrors').textContent = data.totalErrors || 0;
                document.getElementById('criticalErrors').textContent = data.criticalErrors || 0;
                document.getElementById('resolvedErrors').textContent = data.resolvedErrors || 0;
                document.getElementById('unresolvedErrors').textContent = data.unresolvedErrors || 0;

                // Errors list
                const errorsEl = document.getElementById('errorsList');
                if (data.errors && data.errors.length > 0) {
                    errorsEl.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Message</th>
                                    <th>Severity</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.errors.map(error => `
                                    <tr>
                                        <td>${error.type || 'N/A'}</td>
                                        <td>${error.message || 'N/A'}</td>
                                        <td><span class="badge" style="background: ${getSeverityColor(error.severity)}">${error.severity || 'N/A'}</span></td>
                                        <td>${new Date(error.timestamp).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    errorsEl.innerHTML = '<div class="empty-state">No errors reported</div>';
                }
            } catch (error) {
                console.error('Error loading errors:', error);
            }
        }

        function getSeverityColor(severity) {
            const colors = {
                critical: 'rgba(255, 59, 48, 0.2)',
                high: 'rgba(255, 107, 107, 0.2)',
                medium: 'rgba(245, 158, 11, 0.2)',
                low: 'rgba(16, 185, 129, 0.2)'
            };
            return colors[severity] || 'rgba(255, 255, 255, 0.1)';
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (localStorage.getItem('admin_authenticated') === 'true') {
                loadAllData();
            }
        }, 30000);
    </script>

    <!-- Vercel Analytics -->
    <script src="https://va.vercel-scripts.com/v1/script.js" defer></script>

    <!-- Vercel Speed Insights -->
    <script src="https://va.vercel-scripts.com/v1/speed-insights/script.js" defer></script>
</body>
</html>
